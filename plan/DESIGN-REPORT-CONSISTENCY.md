# Report Consistency — Design Specification

> **Branch:** `feature/report_consistency`

---

## 1. Problem Statement

PUnit's user-visible output is generated by classes scattered across seven packages. Each class formats its own output independently, resulting in inconsistencies in:

- **Label alignment** — three different label widths (18, 20, 21) across reports
- **Section headers** — some use `UPPERCASE`, others `Lowercase:` with colon, some omit headers entirely
- **List formatting** — some use `"  • "` (indented), others `"• "` (flush), others use numbered lists with varying indent
- **Duration formatting** — two independent implementations producing different styles (`3m 45s` vs `3 minutes`)
- **Warning presentation** — some use emoji prefixes (`⚠️`), others use PUnitReporter-framed blocks; some do both
- **Provenance lines** — same information formatted differently in summary vs transparent mode

The root cause: `PUnitReporter` provides formatting *primitives* (header divider, label-value padding, footer divider) but imposes no *grammar*. There is no contract defining what a PUnit report body looks like between the dividers.

---

## 2. Design Principles

1. **Consistent grammar, not uniformity.** Not every output should look identical — but every framed report should follow the same structural rules.
2. **The frame signals statistical reasoning.** The `═` chrome is reserved for outputs that represent statistical conclusions or test execution results. Configuration validation errors and IDE-level hints do not get the frame.
3. **Two label widths, not three.** A standard width for most reports and a wider one for statistical detail sections with longer labels. Both defined as constants in one place.
4. **One duration formatter per scale.** Calendar-scale durations ("3 days", "5 hours") and execution-scale durations ("3m 45s") serve different audiences but each should have exactly one implementation.
5. **Minimal disruption.** The `═` header/footer chrome, the 78-character width, the 2-space body indent, `RateFormat` for pass rates — these are fine and stay unchanged.

---

## 3. Scope

### 3.1 Framed Reports (use PUnitReporter header/footer)

| # | Category                  | Title Pattern                      | When Emitted               | Current Owner                |
|---|---------------------------|------------------------------------|----------------------------|------------------------------|
| 1 | Test Configuration        | `TEST CONFIGURATION`               | Pre-test                   | `FinalConfigurationLogger`   |
| 2 | Verdict Summary           | `VERDICT: PASS/FAIL (INTENT)`      | Post-test, non-transparent | `ResultPublisher`            |
| 3 | Statistical Analysis      | `STATISTICAL ANALYSIS`             | Post-test, transparent     | `ConsoleExplanationRenderer` |
| 4 | Execution Plan            | `EXECUTION PLAN`                   | Pre-test, pacing enabled   | `PacingReporter`             |
| 5 | Pacing Conflict           | `PACING CONFLICT`                  | Pre-test, budget vs pacing | `PacingReporter`             |
| 6 | Baseline Expiration       | `BASELINE EXPIRED` / `EXPIRING...` | Post-verdict               | `ExpirationWarningRenderer`  |
| 7 | Covariate Non-Conformance | `COVARIATE NON-CONFORMANCE`        | Post-verdict               | `CovariateWarningRenderer`   |
| 8 | Factor Consistency        | `FACTOR CONSISTENCY WARNING`       | Post-baseline-selection    | `FactorConsistencyValidator` |

### 3.2 Grammar-Aligned Exception (not framed)

| Category      | Current Mechanism                                        | Decision                                                                                                                                                                                                                                        |
|---------------|----------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Infeasibility | `ExtensionConfigurationException` with formatted message | Keep as exception. The JUnit extension flow makes this the natural mechanism — the message appears attached to the failed test in IDE and CI. Apply body grammar (label widths, section headers) to the message content without the `═` chrome. |

### 3.3 Not Changed

| Category                                        | Why                                                           |
|-------------------------------------------------|---------------------------------------------------------------|
| `NoCompatibleBaselineException`                 | Configuration/environment error, not statistical reasoning    |
| `ProbabilisticTestValidator` errors             | Invalid parameter values                                      |
| Sample failure hints (`SampleFailureFormatter`) | Terse IDE exception messages — intentionally different format |
| JUnit TestReporter entries                      | Structured key-value properties, not console output           |
| YAML file output                                | Generated data files, not console reports                     |

---

## 4. Body Grammar Specification

### 4.1 Elements

A report body is a sequence of the following elements:

| Element           | Description                                                                | Example                                      |
|-------------------|----------------------------------------------------------------------------|----------------------------------------------|
| **Subject**       | Test or method name. Always first, followed by blank line.                 | `testMethodName`                             |
| **Section**       | ALL CAPS header, no colon. Content beneath is indented 2 spaces.           | `OBSERVED DATA`                              |
| **Label-value**   | Label left-padded to fixed width, followed by value. Label includes colon. | `Mode:                SLA-DRIVEN`            |
| **Bullet**        | `• ` prefix                                                                | `• Increase samples to at least 52`          |
| **Numbered item** | `N. ` prefix                                                               | `1. Reduce sample count`                     |
| **Note**          | `Note: ` prefix for supplementary information in summary mode              | `Note: Sample not sized for verification...` |
| **Narrative**     | Plain text, word-wrapped at 78 characters                                  | Explanatory sentences                        |

### 4.2 Indentation Model

`PUnitReporter.format()` adds 2-space indent to every line of the body. Body builders work at column 0 relative to this. The final rendered columns are:

| Context                               | Body column | Rendered column |
|---------------------------------------|-------------|-----------------|
| Subject line                          | 0           | 2               |
| Section header                        | 0           | 2               |
| Content under a section               | 2           | 4               |
| Top-level content (no section header) | 0           | 2               |

### 4.3 Spacing Rules

- Blank line after the subject line
- Blank line between sections
- No blank line between consecutive label-value pairs within the same section
- Blank line before a trailing notes block
- No blank line between consecutive notes

### 4.4 Label Widths

Label width is defined by a **reference label line** — a string whose visible padding IS the specification. The numeric constant is derived from it, so text blocks and programmatic `labelValueLn()` calls always agree on alignment:

```java
/**
 * Reference label line — defines the column at which values align in standard
 * PUnit reports. LABEL_WIDTH is derived from this reference so that text blocks
 * and programmatic labelValueLn() calls always agree on alignment.
 */
private static final String LABEL_REFERENCE = "Mode:                ";
public static final int LABEL_WIDTH = LABEL_REFERENCE.length();

/** Detail label reference — for statistical analysis sections with longer labels. */
private static final String DETAIL_LABEL_REFERENCE = "Threshold derivation:  ";
public static final int DETAIL_LABEL_WIDTH = DETAIL_LABEL_REFERENCE.length();
```

| Constant             | Derived Value | Accommodates                                                                                               |
|----------------------|---------------|------------------------------------------------------------------------------------------------------------|
| `LABEL_WIDTH`        | 21            | `Observed pass rate:` (19), `Baseline created:` (17), `Threshold origin:` (17) — all with ≥1 space padding |
| `DETAIL_LABEL_WIDTH` | 23            | `Threshold derivation:` (21), `Confidence interval:` (22) — all with ≥1 space padding                      |

If a developer changes the reference string's padding, the constant follows. If a text block's alignment drifts from the reference, the discrepancy is visible by comparing the two.

`LABEL_WIDTH` is the default for all framed reports. `DETAIL_LABEL_WIDTH` is used only within statistical analysis sections where labels are inherently longer.

The existing constants `DEFAULT_LABEL_WIDTH` (18) and `STATS_LABEL_WIDTH` (21) are replaced.

### 4.5 Section Headers

All section headers within framed reports follow the same convention:

- ALL CAPS
- No colon
- No underline or decorative characters
- At column 0 of the body (rendered at column 2)

Examples: `OBSERVED DATA`, `CONFIGURATION`, `FEASIBILITY`, `PACING CONSTRAINTS`, `COMPUTED PLAN`, `REMEDIATION`, `THRESHOLD PROVENANCE`.

### 4.6 Text Blocks vs StringBuilder

Java text blocks are preferred where the source-to-output visual correspondence holds — i.e., what you read in the code is close to what the user sees. The choice depends on the content type:

**Text blocks** — for narrative paragraphs and simple, low-variability content:

```java
String body = """
The baseline used for statistical inference has expired.

%s

Consider running a fresh MEASURE experiment to update the baseline."""
    .formatted(labelValueBlock);
```

This works because the prose is static, the structure is fixed, and the few interpolated values don't break the visual correspondence.

**`labelValueLn()`** — for structured data sections with aligned labels:

```java
sb.append(PUnitReporter.labelValueLn("Mode:", "SLA-DRIVEN"));
sb.append(PUnitReporter.labelValueLn("Threshold:", rate));
```

Label-value alignment depends on `LABEL_WIDTH`, a constant. A text block would hardcode the whitespace — if the constant changes, every text block's spacing breaks silently. `labelValueLn()` derives alignment from the constant, which is its whole purpose.

**`StringBuilder`** — for dynamic, conditional content:

Reports with optional sections (provenance, termination details, notes), variable-length lists (covariate bullets, pacing constraints), or mode-dependent structure (summary vs transparent) are inherently dynamic. A text block with half its content behind `if` statements loses the WYSIWYG property.

**Hybrid** — the common case for PUnit reports:

Most reports combine a fixed narrative frame with dynamic structured content. The narrative parts (opening sentences, remediation guidance, explanatory prose) can be text blocks; the structured parts use `labelValueLn()`. For example, a report builder might use a text block for the opening, build label-value pairs into a string, then use another text block for the closing guidance.

**Indentation with text blocks:** Body text must be flush-left (column 0) because `PUnitReporter.format()` adds 2-space indent to every line. A text block whose content has leading whitespace (from Java source indentation) will be over-indented in the final output. Use the text block's incidental whitespace stripping correctly — align the closing `"""` to control what is stripped.

---

## 5. Duration Formatting Consolidation

### 5.1 Current State

Two independent implementations:

| Class                       | Method                     | Input                | Output Style                            |
|-----------------------------|----------------------------|----------------------|-----------------------------------------|
| `ExpirationWarningRenderer` | `formatDuration(Duration)` | `java.time.Duration` | `"3 days"`, `"5 hours"`, `"12 minutes"` |
| `PacingReporter`            | `formatDuration(long ms)`  | milliseconds         | `"3m 45s"`, `"1h 30m"`, `"45s"`         |

### 5.2 Design

Move both into a shared utility class `DurationFormat` in the `reporting` package (alongside `RateFormat`):

```java
public final class DurationFormat {

    /** Calendar-scale: "3 days", "5 hours", "12 minutes", "less than a minute". */
    public static String calendar(Duration duration) { ... }

    /** Execution-scale: "1h 30m", "5m 23s", "45s", "<1s". */
    public static String execution(long ms) { ... }
}
```

`ExpirationWarningRenderer.formatDuration` and `PacingReporter.formatDuration` are replaced by calls to `DurationFormat.calendar` and `DurationFormat.execution` respectively.

`ExpirationWarningRenderer.formatDuration(Duration)` is currently `public` — it may have external callers. It will be deprecated with delegation to `DurationFormat.calendar`, then removed in a subsequent release.

---

## 6. Changes Per Category

### 6.1 Test Configuration (`FinalConfigurationLogger`)

**Current issues:**
- Uses `DEFAULT_LABEL_WIDTH` (18)
- No subject line (test name is in the *title*, not the body)

**Changes:**
- Update label width from 18 → `LABEL_WIDTH` (20)
- Move test name into body as subject line; simplify title to `TEST CONFIGURATION`

**Before:**
```
═ TEST CONFIGURATION FOR: testMethodName ═══════════════════ PUnit ═

  Mode:              SLA-DRIVEN
  Intent:            VERIFICATION
  Threshold:         0.9500 (SLA)
  Samples:           100

══════════════════════════════════════════════════════════════════════════════
```

**After:**
```
═ TEST CONFIGURATION ═══════════════════════════════════════ PUnit ═

  testMethodName

  Mode:                SLA-DRIVEN
  Intent:              VERIFICATION
  Spec:                ShoppingBasketUseCase
  Threshold:           0.9500 (SLA)
  Contract:            Acme SLA v3.2 §4.1
  Samples:             100

══════════════════════════════════════════════════════════════════════════════
```

**Files:** `FinalConfigurationLogger.java`, `FinalConfigurationLoggerTest.java`

### 6.2 Verdict Summary (`ResultPublisher.printConsoleSummary`)

**Current issues:**
- Provenance lines use manual 2-space indent (`"  Threshold origin: %s"`) — subordinate to the observed-rate line, but they're peers
- `"Observed pass rate: %s (%d/%d) >= min pass rate: %s"` is freeform, not label-value
- `"Elapsed: %dms"` is freeform
- Termination/analysis lines are freeform
- Notes use `"Note: %s"` with no consistent indent
- Test name in body but no blank line after it

**Changes:**
- All data lines become label-value pairs at `LABEL_WIDTH` (20)
- Provenance lines at same indent level as other label-value pairs (no extra indent)
- Subject line followed by blank line
- Notes separated by blank line from main content
- Move test name out of title where feasible (title remains `VERDICT: PASS/FAIL (INTENT)`)

**Before:**
```
═ VERDICT: PASS (VERIFICATION) ═════════════════════════════ PUnit ═

  testMethodName
  Observed pass rate: 0.9500 (95/100) >= min pass rate: 0.9000
    Threshold origin: SLA
    Contract ref: Acme SLA v3.2 §4.1
  Elapsed: 1234ms

══════════════════════════════════════════════════════════════════════════════
```

**After:**
```
═ VERDICT: PASS (VERIFICATION) ═════════════════════════════ PUnit ═

  testMethodName

  Observed pass rate:  0.9500 (95/100) >= required: 0.9000
  Threshold origin:    SLA
  Contract:            Acme SLA v3.2 §4.1
  Elapsed:             1234ms

══════════════════════════════════════════════════════════════════════════════
```

**Budget-exhaustion variant (after):**
```
═ VERDICT: FAIL (VERIFICATION) ═════════════════════════════ PUnit ═

  testMethodName

  Samples executed:    200 of 1000 (budget exhausted)
  Pass rate:           0.9250 (185/200), required: 0.9000
  Termination:         Token budget exhausted
  Elapsed:             4567ms

══════════════════════════════════════════════════════════════════════════════
```

**Early-termination variant with note (after):**
```
═ VERDICT: FAIL (SMOKE) ════════════════════════════════════ PUnit ═

  testMethodName

  Observed pass rate:  0.6000 (18/30) < required: 0.9500
  Termination:         Impossibility — threshold unreachable
  Analysis:            Needed 29 successes, maximum possible is 30
  Elapsed:             456ms

  Note: Sample not sized for verification (N=30, need 52 for 0.9500
  at 95% confidence).

══════════════════════════════════════════════════════════════════════════════
```

**Files:** `ResultPublisher.java`, `ResultPublisherTest.java`

### 6.3 Statistical Analysis (`ConsoleExplanationRenderer`)

**Current issues:**
- Uses `STATS_LABEL_WIDTH` (21) — changing to `DETAIL_LABEL_WIDTH` (23)
- Hypothesis section uses ad-hoc manual alignment (hardcoded spaces) instead of `labelValueLn`
- Provenance section mixes `statLabel` and manual `String.format` for `"Contract ref:"`
- `renderZTestCalculation` has an empty line `"  \n"` — a trailing-space artifact
- Word wrapping in verdict section has hardcoded column counts (`lineLength = 19`, `23`) — should derive from label width

**Changes:**
- Replace `STATS_LABEL_WIDTH` → `DETAIL_LABEL_WIDTH` (23) throughout
- Hypothesis section uses `statLabel()` / `labelValueLn` like all other sections
- Provenance section uses `statLabel()` consistently
- Clean up trailing-space artifacts in z-test rendering
- Derive word-wrap indentation from label width constant, not hardcoded numbers

**Before (hypothesis section):**
```
  HYPOTHESIS TEST
    H₀ (null):        True success rate π ≤ 0.9190
    H₁ (alternative): True success rate π > 0.9190
    Test type:        One-sided binomial proportion test
```

**After:**
```
  HYPOTHESIS TEST
    H₀ (null):             True success rate π ≤ 0.9190
    H₁ (alternative):      True success rate π > 0.9190
    Test type:             One-sided binomial proportion test
```

Values now align with the rest of the statistical sections.

**Files:** `ConsoleExplanationRenderer.java`, `ConsoleExplanationRendererTest.java`

### 6.4 Execution Plan (`PacingReporter.printPreFlightReport`)

**Current issues:**
- Uses freeform `"Samples requested: "` instead of label-value
- Subsection headers use `"Pacing constraints:\n"` (lowercase, colon) instead of `PACING CONSTRAINTS`
- Bullet items use `"  • "` — correct indent under section, but section headers don't follow grammar
- Duration formatting uses local `formatDuration(long ms)` method
- `"Started: "` and `"Proceeding with execution..."` are ad-hoc

**Changes:**
- Section headers → `PACING CONSTRAINTS`, `COMPUTED PLAN`
- `"Samples requested:"` → label-value pair at `LABEL_WIDTH`
- Bullet items under sections remain at 2-space indent (correct per grammar)
- Replace local `formatDuration` with `DurationFormat.execution`
- `"Started:"` → label-value pair
- Remove `"Proceeding with execution..."` (adds no information)

**Before:**
```
═ EXECUTION PLAN ═══════════════════════════════════════════ PUnit ═

  testMethodName
  Samples requested: 200

  Pacing constraints:
    • Max requests/min: 60 RPM

  Computed execution plan:
    • Concurrency: sequential
    • Inter-request delay: 1000ms
    • Effective throughput: 1.0 req/s
    • Estimated duration: 3m 20s
    • Estimated completion: 14:33:20 UTC

  Started: 14:30:00 UTC
  Proceeding with execution...

══════════════════════════════════════════════════════════════════════════════
```

**After:**
```
═ EXECUTION PLAN ═══════════════════════════════════════════ PUnit ═

  testMethodName

  Samples:             200

  PACING CONSTRAINTS
    • Max requests/min: 60 RPM
    • Min delay/sample: 1000ms (derived from RPM)

  COMPUTED PLAN
    Concurrency:         sequential
    Inter-request delay: 1000ms
    Effective throughput: 1.0 req/s
    Estimated duration:  3m 20s
    Estimated completion: 14:33:20 UTC

  Started:             14:30:00 UTC

══════════════════════════════════════════════════════════════════════════════
```

**Files:** `PacingReporter.java`, `PacingReporterTest.java`

### 6.5 Pacing Conflict (`PacingReporter.printFeasibilityWarning`)

**Current issues:**
- Bullets at column 0 (`"• "`) instead of indented under a section
- `"Options:\n"` as a subsection header (lowercase, colon)
- Numbered items use `"  1. "` — inconsistent indent with bullets

**Changes:**
- Narrative opening, then `REMEDIATION` section with numbered items
- Replace local `formatDuration` with `DurationFormat.execution`

**Before:**
```
═ PACING CONFLICT ══════════════════════════════════════════ PUnit ═

  • 200 samples at current pacing would take ~3m 20s
  • Time budget is 1m 0s (timeBudgetMs = 60000)

  Options:
    1. Reduce sample count to ~60
    2. Increase time budget to 3m 30s
    3. Relax pacing constraints (increase rate limits)

══════════════════════════════════════════════════════════════════════════════
```

**After:**
```
═ PACING CONFLICT ══════════════════════════════════════════ PUnit ═

  200 samples at current pacing would take ~3m 20s, but the time
  budget is 1m 0s (timeBudgetMs = 60000).

  REMEDIATION
    1. Reduce sample count to ~60
    2. Increase time budget to 3m 30s
    3. Relax pacing constraints (increase rate limits)

══════════════════════════════════════════════════════════════════════════════
```

**Files:** `PacingReporter.java`, `PacingReporterTest.java`

### 6.6 Baseline Expiration (`ExpirationWarningRenderer`)

**Current issues:**
- Uses `EXPIRATION_LABEL_WIDTH` (20) — happens to match `LABEL_WIDTH` already
- `renderExpiringImminently` and `renderExpiringSoon` use Java text-block templates instead of `labelValueLn`
- Duration formatting uses local `formatDuration(Duration)` method

**Changes:**
- Replace `EXPIRATION_LABEL_WIDTH` → `LABEL_WIDTH`
- `renderExpiringImminently` and `renderExpiringSoon` use same label-value structure as `renderExpired`
- Replace `formatDuration(Duration)` with delegation to `DurationFormat.calendar`; deprecate the public method

**Before (expiring imminently):**
```
═ BASELINE EXPIRING IMMINENTLY ═════════════════════════════ PUnit ═

              Baseline expires in 2 hours (on 2026-02-14 16:30 UTC).
              Schedule a MEASURE experiment to refresh the baseline.

══════════════════════════════════════════════════════════════════════════════
```

The text-block template produces leading whitespace that `PUnitReporter.format()` indents further, causing over-indentation.

**After:**
```
═ BASELINE EXPIRING IMMINENTLY ═════════════════════════════ PUnit ═

  Baseline expires in 2 hours (on 2026-02-14 16:30 UTC).

  Consider scheduling a MEASURE experiment to refresh the baseline.

══════════════════════════════════════════════════════════════════════════════
```

**Files:** `ExpirationWarningRenderer.java`, `ExpirationWarningRendererTest.java`

### 6.7 Covariate Non-Conformance (`CovariateWarningRenderer`)

**Current issues:**
- Builds a raw string with `"⚠️ COVARIATE NON-CONFORMANCE\n"` prefix — not routed through PUnitReporter
- Uses emoji for warning signalling
- Two render methods (`render` for full, `renderShort` for inline) — the full one should become a framed report; the short one stays for inline use in verbose mode caveats

**Changes:**
- `render()` returns a `WarningContent(title, body)` record (same pattern as `ExpirationWarningRenderer`) instead of a raw string. The caller routes it through `PUnitReporter.reportWarn()`.
- Remove `⚠️` emoji — the PUnitReporter frame and WARN log level serve this purpose
- `renderShort()` stays unchanged (it's for inline use, not a standalone report)
- Bullet items use grammar-consistent `"• "` at body column 0

**Before:**
```
⚠️ COVARIATE NON-CONFORMANCE
Statistical inference may be less reliable.

  • day_of_week: baseline=WEEKDAY, test=WEEKEND
  • time_of_day: baseline=MORNING, test=EVENING
```
(Rendered inline, not framed)

**After:**
```
═ COVARIATE NON-CONFORMANCE ════════════════════════════════ PUnit ═

  Statistical inference may be less reliable.

  • day_of_week: baseline=WEEKDAY, test=WEEKEND
  • time_of_day: baseline=MORNING, test=EVENING

══════════════════════════════════════════════════════════════════════════════
```

**Files:** `CovariateWarningRenderer.java`, `CovariateWarningRendererTest.java`, `BaselineSelectionOrchestrator.java` (caller changes)

### 6.8 Factor Consistency (`FactorConsistencyValidator.formatForLog`)

**Current issues:**
- `formatForLog()` returns a string with emoji prefixes (`✓`, `⚠️`, `ℹ️`)
- Mismatch body uses manual alignment (`"  Baseline: ..."`, `"  Test:     ..."`)
- Not routed through PUnitReporter

**Changes:**
- For `MISMATCH`: return a `WarningContent(title, body)` (or equivalent) for routing through `PUnitReporter.reportWarn()`
- For `MATCH` and `NOT_APPLICABLE`: keep as terse log messages (these are informational, not reports)
- Mismatch body uses label-value pairs at `LABEL_WIDTH`
- Remove emoji prefixes

**Before (mismatch):**
```
⚠️ FACTOR CONSISTENCY WARNING
Factor source mismatch detected.
  Baseline: hash=abc12345...6789, source=modelConfigurations, samples=1000
  Test:     hash=def98765...4321, source=testConfigurations
Statistical conclusions may be less reliable.
Ensure the same @FactorSource is used for experiments and tests.
```

**After (mismatch):**
```
═ FACTOR CONSISTENCY WARNING ═══════════════════════════════ PUnit ═

  Factor source mismatch detected. Statistical conclusions may be
  less reliable.

  Baseline hash:       abc12345...6789
  Baseline source:     modelConfigurations
  Baseline samples:    1000
  Test hash:           def98765...4321
  Test source:         testConfigurations

  Ensure the same @FactorSource is used for experiments and tests.

══════════════════════════════════════════════════════════════════════════════
```

**Files:** `FactorConsistencyValidator.java`, `FactorConsistencyValidatorTest.java`, caller in `BernoulliTrialsStrategy` (or wherever the log call is)

### 6.9 Infeasibility Exception (`VerificationFeasibilityEvaluator`)

**Current issues:**
- Uses text-block templates with manual indentation
- Section headers use `"Configuration:"` / `"Feasibility:"` / `"Remediation:"` (title-case, colon)
- Label alignment is ad-hoc within each text block
- Summary and verbose variants have different label widths
- Not framed (remains an exception — see §3.2)

**Changes:**
- Apply grammar to exception message content: `CONFIGURATION`, `FEASIBILITY`, `REMEDIATION` section headers (ALL CAPS, no colon)
- Use `LABEL_WIDTH` (20) for label-value pairs within sections
- Build via `StringBuilder` with `PUnitReporter.labelValueLn()` instead of text-block templates
- Retain the two-tier (summary/verbose) approach

**Before (verbose):**
```

        INFEASIBLE VERIFICATION

          Test:              testMethodName
          Intent:            VERIFICATION

          The configured sample size (N=30) is insufficient for verification
          at the declared confidence level.

          Configuration:
            Target (p₀):     0.9500
            Confidence:       0.95 (α = 0.05)
            Samples:          30

          Feasibility:
            Criterion:        Wilson score one-sided lower bound
            Minimum N:        52
            Assumption:       i.i.d. Bernoulli trials

          Remediation:
            - Increase samples to at least 52, or
            - Set intent = SMOKE to run as a sentinel test
```

**After (verbose):**
```

INFEASIBLE VERIFICATION

testMethodName

The configured sample size (N=30) is insufficient for verification
at the declared confidence level.

CONFIGURATION
  Target (p₀):         0.9500
  Confidence:          0.95 (α = 0.05)
  Samples:             30

FEASIBILITY
  Criterion:           Wilson score one-sided lower bound
  Minimum N:           52
  Assumption:          i.i.d. Bernoulli trials

REMEDIATION
  • Increase samples to at least 52
  • Set intent = SMOKE to run as a sentinel test
```

No `═` chrome, but the same body grammar. A developer who sees this after seeing framed reports will recognise the structure.

**Files:** `VerificationFeasibilityEvaluator.java`, `VerificationFeasibilityEvaluatorTest.java`

---

## 7. `PUnitReporter` Changes

### 7.1 Label Width Constants

The existing independently-declared constants are replaced by reference-derived constants:

| Old                        | New                       | Derived From                                         |
|----------------------------|---------------------------|------------------------------------------------------|
| `DEFAULT_LABEL_WIDTH` (18) | `LABEL_WIDTH` (21)        | `LABEL_REFERENCE = "Mode:                "`          |
| `STATS_LABEL_WIDTH` (21)   | `DETAIL_LABEL_WIDTH` (23) | `DETAIL_LABEL_REFERENCE = "Threshold derivation:  "` |

The reference strings are the source of truth; the constants are derived measurements. See §4.4.

### 7.2 New Utility Methods

None required. The existing `labelValue`, `labelValueLn`, `headerDivider`, `footerDivider`, `reportInfo`, `reportWarn`, `reportError` methods are sufficient. The grammar is a convention enforced by callers, not by new API.

### 7.3 WarningContent Record

`ExpirationWarningRenderer` already defines a `WarningContent(title, body)` record. `CovariateWarningRenderer` and `FactorConsistencyValidator` need the same pattern. Options:

- **Preferred:** Move `WarningContent` to `PUnitReporter` as a shared record, since all three produce content for `PUnitReporter` to frame.
- Alternative: Each class defines its own record (current state for expiration; adds two more).

The preferred approach avoids duplication and makes the "produce title+body → hand to reporter" pattern explicit.

---

## 8. New Class: `DurationFormat`

**Package:** `org.javai.punit.reporting`

**Purpose:** Centralised duration formatting alongside `RateFormat`.

```java
public final class DurationFormat {

    /** Calendar-scale: "3 days", "5 hours", "12 minutes", "less than a minute". */
    public static String calendar(Duration duration) { ... }

    /** Execution-scale: "1h 30m", "5m 23s", "45s", "<1s". */
    public static String execution(long ms) { ... }
}
```

**Callers:**
- `ExpirationWarningRenderer.formatDuration(Duration)` → delegates to `DurationFormat.calendar()`
- `PacingReporter.formatDuration(long)` → replaced by `DurationFormat.execution()`

---

## 9. Files Modified

### Production Code

| File                                                     | Change                                                                          |
|----------------------------------------------------------|---------------------------------------------------------------------------------|
| `reporting/PUnitReporter.java`                           | Rename constants; add `WarningContent` record                                   |
| `reporting/DurationFormat.java`                          | **New file** — shared duration formatting                                       |
| `ptest/engine/ResultPublisher.java`                      | Reformat verdict body to use label-value pairs, update label width              |
| `ptest/engine/FinalConfigurationLogger.java`             | Move test name to body, update label width, simplify title                      |
| `ptest/engine/FactorConsistencyValidator.java`           | Mismatch → `WarningContent` with label-value body                               |
| `statistics/transparent/ConsoleExplanationRenderer.java` | Update label width, fix hypothesis section alignment, clean up z-test artifacts |
| `statistics/VerificationFeasibilityEvaluator.java`       | Apply grammar to exception messages                                             |
| `controls/pacing/PacingReporter.java`                    | Section headers, label-value pairs, delegate to `DurationFormat`                |
| `spec/expiration/ExpirationWarningRenderer.java`         | Delegate to `DurationFormat`, fix text-block templates, update label width      |
| `spec/baseline/covariate/CovariateWarningRenderer.java`  | Return `WarningContent`, remove emoji                                           |
| `ptest/engine/BaselineSelectionOrchestrator.java`        | Updated caller for `CovariateWarningRenderer`                                   |

### Test Code

| File                                                         | Change                                          |
|--------------------------------------------------------------|-------------------------------------------------|
| `reporting/DurationFormatTest.java`                          | **New file** — tests for both formatting styles |
| `reporting/PUnitReporterTest.java`                           | Update expected label widths                    |
| `ptest/engine/ResultPublisherTest.java`                      | Update expected output format                   |
| `ptest/engine/FinalConfigurationLoggerTest.java`             | Update expected output format                   |
| `ptest/engine/FactorConsistencyValidatorTest.java`           | Update expected format for mismatch             |
| `statistics/transparent/ConsoleExplanationRendererTest.java` | Update expected label alignment                 |
| `statistics/VerificationFeasibilityEvaluatorTest.java`       | Update expected exception messages              |
| `controls/pacing/PacingReporterTest.java`                    | Update expected output format                   |
| `spec/expiration/ExpirationWarningRendererTest.java`         | Update expected output format                   |
| `spec/baseline/covariate/CovariateWarningRendererTest.java`  | Update for `WarningContent` return type         |

---

## 10. Implementation Order

The changes have a natural dependency order:

1. **`PUnitReporter`** — rename constants, add `WarningContent`. Everything else depends on this.
2. **`DurationFormat`** — new utility. `PacingReporter` and `ExpirationWarningRenderer` depend on it.
3. **Individual categories** — can be done in any order after steps 1–2, since they are independent of each other. Suggested order (least coupled → most coupled):
   1. `FinalConfigurationLogger` (simple, flat)
   2. `ExpirationWarningRenderer` (flat + duration)
   3. `PacingReporter` (sections + duration)
   4. `VerificationFeasibilityEvaluator` (exception, sections)
   5. `ResultPublisher` (verdict body — most tests affected)
   6. `ConsoleExplanationRenderer` (statistical sections — most formatting)
   7. `CovariateWarningRenderer` (return type change → caller update)
   8. `FactorConsistencyValidator` (return type change → caller update)
4. **Caller updates** — `BaselineSelectionOrchestrator`, `BernoulliTrialsStrategy` (for changed return types in steps 3.7–3.8).

---

## 11. Testing Strategy

Each change follows the existing project convention: update the corresponding `*Test.java` class with assertions on the formatted output.

- **String assertions** use AssertJ `assertThat(output).contains(...)` for key fragments rather than exact full-string matching, making tests resilient to minor wording changes while still enforcing structural properties (label alignment, section headers, spacing).
- **`VerdictCatalogueTest`** can be run manually after all changes to visually verify the end-to-end output for both SUMMARY and VERBOSE modes. This produces `build/verdict-catalogue-{LEVEL}.md`.
- **Architecture tests** are unaffected — no new cross-package dependencies are introduced. `DurationFormat` lives in `reporting`, which is already depended on by all output-producing packages.

---

## 12. Documentation Updates

After all production and test code changes are complete, update the documentation in `docs/` so that every report example matches what the codebase now produces.

### Files

| File                      | Sections Affected                                                                                                                                                                                                                                                                                                                         |
|---------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `docs/USER-GUIDE.md`      | §Understanding Test Results (verdict example, lines ~962–968), §Transparent Statistics Mode (statistical analysis example), §Baseline Expiration (expiration warning example), §Covariate-Aware Baseline Selection (covariate warning example), §Budget Control (budget exhaustion examples), §Threshold Provenance (SLA verdict example) |
| `docs/VERDICT-CATALOG.md` | All example outputs (if present)                                                                                                                                                                                                                                                                                                          |

### Approach

- Run `VerdictCatalogueTest` in both SUMMARY and VERBOSE modes to produce fresh reference output
- Replace each inline example in the documentation with output that matches the new grammar
- Verify label alignment, section headers, and spacing in every example block
